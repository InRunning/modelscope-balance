# é­”æ­-balance

ä¸€ä¸ªç”¨Goç¼–å†™çš„é­”æ­APIè´Ÿè½½å‡è¡¡æœåŠ¡ï¼Œé€šè¿‡ä¼ å…¥å¤šä¸ªAPI Keyå®ç°è´Ÿè½½å‡è¡¡ï¼Œåªè´Ÿè´£è½¬å‘å’Œè´Ÿè½½å‡è¡¡ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ”‘ æ”¯æŒå¤šä¸ªAPI Keyçš„è´Ÿè½½å‡è¡¡
- ğŸ”„ è½®è¯¢è´Ÿè½½å‡è¡¡ç­–ç•¥
- ğŸ¥ è‡ªåŠ¨å¥åº·æ£€æŸ¥
- ğŸ“Š å®æ—¶ç»Ÿè®¡ä¿¡æ¯
- ğŸš€ é«˜æ€§èƒ½åå‘ä»£ç†
- ğŸ“ è¯¦ç»†çš„æ—¥å¿—è®°å½•
- âš™ï¸ çµæ´»çš„é…ç½®ç®¡ç†

## å¿«é€Ÿå¼€å§‹

### 1. é…ç½®API Keys

ç¼–è¾‘ `config.json` æ–‡ä»¶ï¼Œæ·»åŠ ä½ çš„é­”æ­API Keysï¼š

```json
{
  "api_keys": [
    "your_api_key_1_here",
    "your_api_key_2_here",
    "your_api_key_3_here"
  ],
  "server_port": "8080",
  "target_url": "https://api-inference.modelscope.cn",
  "health_check": true,
  "health_path": "/v1/models"
}
```

### 2. å¯åŠ¨æœåŠ¡

ä½¿ç”¨Makefileï¼š

```bash
# æ„å»ºå¹¶è¿è¡Œ
make run

# æˆ–è€…å…ˆæ„å»ºå†è¿è¡Œ
make build
./modelscope-balance
```

ä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼š

```bash
./start.sh
```

ç›´æ¥ä½¿ç”¨Goå‘½ä»¤ï¼š

```bash
go run main.go
```

### 3. ä½¿ç”¨æœåŠ¡

æœåŠ¡å¯åŠ¨åï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ä½¿ç”¨ï¼š

#### APIè°ƒç”¨ç¤ºä¾‹

```bash
curl -X POST http://localhost:8080/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{
    "model": "deepseek-ai/DeepSeek-V3.1",
    "messages": [
      {"role": "system","content": "ä½ æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹."},
      {"role": "user","content": "å¸¸è§çš„åå­—èŠ±ç§‘æ¤ç‰©æœ‰å“ªäº›ï¼Ÿ"}
    ]
  }'
```

#### æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯

```bash
curl http://localhost:8080/stats
```

#### å¥åº·æ£€æŸ¥

```bash
curl http://localhost:8080/health
```

## é…ç½®è¯´æ˜

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `api_keys` | array | [] | é­”æ­API Keyåˆ—è¡¨ |
| `server_port` | string | "8080" | æœåŠ¡ç›‘å¬ç«¯å£ |
| `target_url` | string | "https://api-inference.modelscope.cn" | ç›®æ ‡APIæœåŠ¡å™¨åœ°å€ |
| `health_check` | boolean | true | æ˜¯å¦å¯ç”¨å¥åº·æ£€æŸ¥ |
| `health_path` | string | "/v1/models" | å¥åº·æ£€æŸ¥è·¯å¾„ |

## è´Ÿè½½å‡è¡¡ç­–ç•¥

å½“å‰å®ç°é‡‡ç”¨è½®è¯¢ï¼ˆRound Robinï¼‰ç­–ç•¥ï¼š

1. æŒ‰é¡ºåºé€‰æ‹©API Key
2. è·³è¿‡ä¸å¥åº·çš„API Key
3. è‡ªåŠ¨é‡è¯•ç›´åˆ°æ‰¾åˆ°å¯ç”¨çš„API Key
4. å¦‚æœæ‰€æœ‰API Keyéƒ½ä¸å¯ç”¨ï¼Œè¿”å›503é”™è¯¯

## å¥åº·æ£€æŸ¥

- æ¯30ç§’è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡API Keyçš„å¥åº·çŠ¶æ€
- é€šè¿‡è®¿é—® `/v1/models` ç«¯ç‚¹è¿›è¡Œå¥åº·æ£€æŸ¥
- å¦‚æœAPIè¿”å›5xxé”™è¯¯æˆ–è¿æ¥å¤±è´¥ï¼Œæ ‡è®°ä¸ºä¸å¥åº·
- ä¸å¥åº·çš„API Keyä¼šè¢«è·³è¿‡ï¼Œç›´åˆ°æ¢å¤å¥åº·

## ç›‘æ§å’Œæ—¥å¿—

### ç»Ÿè®¡ä¿¡æ¯

è®¿é—® `/stats` ç«¯ç‚¹è·å–è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯ï¼š

```json
{
  "api_key_1...": {
    "healthy": true,
    "last_used": "2024-01-01T12:00:00Z",
    "requests": 100
  },
  "api_key_2...": {
    "healthy": false,
    "last_used": "2024-01-01T11:30:00Z",
    "requests": 50
  }
}
```

### æ—¥å¿—è¾“å‡º

æœåŠ¡ä¼šè¾“å‡ºè¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
- è¯·æ±‚è½¬å‘ä¿¡æ¯
- API Keyå¥åº·çŠ¶æ€å˜åŒ–
- é”™è¯¯å’Œå¼‚å¸¸ä¿¡æ¯

## é¡¹ç›®ç»“æ„

```
modelscope-balance/
â”œâ”€â”€ main.go              # ä¸»ç¨‹åºæ–‡ä»¶
â”œâ”€â”€ config.json          # é…ç½®æ–‡ä»¶
â”œâ”€â”€ go.mod               # Goæ¨¡å—æ–‡ä»¶
â”œâ”€â”€ Makefile             # æ„å»ºè„šæœ¬
â”œâ”€â”€ start.sh             # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ README.md            # è¯´æ˜æ–‡æ¡£
â””â”€â”€ docs/
    â””â”€â”€ é­”æ­apiè°ƒç”¨.curl # APIè°ƒç”¨ç¤ºä¾‹
```

## å¼€å‘å’Œæ„å»º

### å¼€å‘ç¯å¢ƒè¦æ±‚

- Go 1.21+
- é­”æ­API Key

### æ„å»ºå‘½ä»¤

```bash
# æ„å»ºç¨‹åº
make build

# è¿è¡Œæµ‹è¯•
make test

# æ¸…ç†æ„å»ºæ–‡ä»¶
make clean

# å®‰è£…ä¾èµ–
make deps
```

### è‡ªå®šä¹‰æ„å»º

```bash
# æ„å»ºä¸ºLinuxå¯æ‰§è¡Œæ–‡ä»¶
GOOS=linux GOARCH=amd64 go build -o modelscope-balance-linux main.go

# æ„å»ºä¸ºWindowså¯æ‰§è¡Œæ–‡ä»¶
GOOS=windows GOARCH=amd64 go build -o modelscope-balance.exe main.go

# æ„å»ºä¸ºmacOSå¯æ‰§è¡Œæ–‡ä»¶
GOOS=darwin GOARCH=amd64 go build -o modelscope-balance-darwin main.go
```

## æ³¨æ„äº‹é¡¹

1. **API Keyå®‰å…¨**ï¼šè¯·å¦¥å–„ä¿ç®¡ä½ çš„API Keyï¼Œä¸è¦å°†é…ç½®æ–‡ä»¶æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ
2. **è´Ÿè½½å‡è¡¡**ï¼šå½“å‰å®ç°ä¸ºç®€å•çš„è½®è¯¢ç­–ç•¥ï¼Œå¦‚éœ€æ›´å¤æ‚çš„ç­–ç•¥å¯ä»¥è‡ªè¡Œæ‰©å±•
3. **é”™è¯¯å¤„ç†**ï¼šæœåŠ¡ä¼šè‡ªåŠ¨å¤„ç†APIé”™è¯¯ï¼Œä½†ä¸åŒ…å«é‡è¯•é€»è¾‘
4. **æ€§èƒ½è€ƒè™‘**ï¼šåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå»ºè®®ä½¿ç”¨æ›´ä¸“ä¸šçš„è´Ÿè½½å‡è¡¡è§£å†³æ–¹æ¡ˆ

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ï¼Œè¯¦è§LICENSEæ–‡ä»¶ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ã€‚